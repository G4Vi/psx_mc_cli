#!/usr/bin/perl
use strict; use warnings;
use Encode qw(decode);
use FindBin;
use lib "$FindBin::Bin/../lib";
use PSX::MC;
binmode(STDERR, "encoding(UTF-8)");
(@ARGV >= 1) or die("No mcd provided");

# load the memory card
my $file = $ARGV[0];
my $mcfile = PSX::MC->load($file);
if(!$mcfile) {
	die("Failed to open $file");
}
elsif($mcfile->{'type'} ne 'mcd') {
	die("Unsupported input format");
}

my $searchfname;
$searchfname = decode('utf8', $ARGV[1]) if (@ARGV >= 2);
$mcfile->foreachDirEntry(sub {
	my ($entry, $newsave, $entrydata) = @_;
	return if(! $newsave);	

    # find the save
	if(PSX::MC::SaveNameAndTitleMatch($newsave, $searchfname)) {
		my $mcs = $entrydata . $newsave->{'data'};
		print $mcs;
		exit 0;	
	}
});	
warn "Failed to extract save";
exit 1;
